/*! Dapper Doe - v0.2.0 - 2015-02-03
* https://github.com/pascalmerme/dapperdoe
* Copyright (c) 2015 Pascal Merme; Licensed MIT */
(function(){window.DapperDoe={}}).call(this),function(){DapperDoe.Template=function(){function a(a){this.attributes=a,this.parseSnippets(a.callback)}return a.prototype.parseSnippets=function(a){var b;return b=$('<div id="dd_snippets_loader"></div>'),b.load(""+this.attributes.path,function(c){return function(){var d;return d=[],b.children().each(function(){return d.push({previewUrl:$(this).data("preview"),html:$(this).html()})}),c.snippetsPreviews=d,a()}}(this))},a}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};DapperDoe.SnippetPreview=function(){function a(a){this.snippet=a.snippet,this.index=a.index,this.buildSnippet(),this.enableDraggable(),this.events()}return a.prototype.events=function(){return this.$el.bind("addSnippet",function(a){return function(b,c){return a.addSnippet(b,c)}}(this))},a.prototype.buildSnippet=function(){return this.$el=$("<div class='dd_snippet'></div>"),this.$el.attr("id","dd_snippet"+this.index),this.$el.append($("<img src='"+this.snippet.previewUrl+"' />"))},a.prototype.enableDraggable=function(){return this.$el.draggable({appendTo:window.app.topElement,helper:"clone",revert:!1,connectToSortable:window.app.topElement})},a.prototype.addSnippet=function(a,b){return b.element.find("img").remove(),b.element.append($(this.snippet.html)),new DapperDoe.Snippet({el:b.element})},a}(),DapperDoe.Sidebar=function(){function a(a){this.collection=a.collection,this.buildSidebar(),this.events()}return a.prototype.events=function(){return this.$el.find(".dd_sidebar_opener").bind("click",function(a){return function(){return a.toggleSidebar()}}(this))},a.prototype.buildSidebar=function(){var a,b,c,d,e,f;for(this.$el=$("<div id='dd_sidebar'></div>"),this.$el.append("<span class='dd_sidebar_opener'><i class='fa fa-pencil'></i></span>"),this.$el.append("<div class='dd_snippets_previews'></div>"),f=this.collection,a=d=0,e=f.length;e>d;a=++d)b=f[a],c=new DapperDoe.SnippetPreview({snippet:b,index:a}),this.$el.find("> div").append(c.$el);return $("body").append(this.$el)},a.prototype.toggleSidebar=function(){return this.$el.toggleClass("opened",200)},a}(),DapperDoe.Snippet=function(){function b(b){this.changeColor=a(this.changeColor,this),this.$el=b.el,this.addTools(),this.parseSnippet(),this.events()}return b.prototype.events=function(){return this.$el.bind("mouseover",function(a){return function(){return a.showTools()}}(this)),this.$el.bind("mouseleave",function(a){return function(){return a.hideTools()}}(this)),this.$el.find(".dd_tools .snippet_destroyer").bind("click",function(a){return function(){return a.destroy()}}(this)),this.$el.find(".color").bind("click",function(a){return function(b){return a.changeColor(b)}}(this)),this.$el.find(".dd_tools .snippet_settings").bind("click",function(a){return function(){return a.toggleSettings()}}(this)),this.$el.find(".dd_snippet_settings").bind("click",function(a){return function(){return a.hideSettings()}}(this)),this.$el.find(".dd_image_background").bind("click",function(a){return function(b){return a.imageBackgroundFileSelector(b)}}(this)),this.$el.find(".dd_image_background .image_input, .dd_snippet_padding").bind("click",function(){return function(a){return a.stopPropagation()}}(this)),this.$el.find(".dd_image_background .image_input").bind("change",function(a){return function(b){return a.uploadBackgroundImage(b)}}(this)),this.$el.find(".dd_snippet_padding").bind("input",function(a){return function(b){return a.updatePadding(b)}}(this))},b.prototype.toggleSettings=function(){return this.$el.find(".dd_snippet_settings").is(":visible")?this.hideSettings():this.showSettings()},b.prototype.showTools=function(){return this.$el.find(".dd_tool").show()},b.prototype.hideTools=function(){return this.$el.find(".dd_tool").hide()},b.prototype.addTools=function(){var a,b,c,d;for(this.$el.append("<div class='dd_tools dd_ui'> <div class='dd_tool snippet_mover'><i class='fa fa-arrows'></i></div> <div class='dd_tool snippet_settings'><i class='fa fa-adjust'></i></div> <div class='dd_tool snippet_destroyer'><i class='fa fa-trash'></i></div> </div>"),this.$el.append("<div class='dd_snippet_settings dd_ui'><div class='dd_background_manager'></div></div>"),d=window.app.colorPalette,b=0,c=d.length;c>b;b++)a=d[b],this.$el.find(".dd_snippet_settings .dd_background_manager").append("<span class='color' style='background: #"+a+";' data-color='"+a+"'></span>");return this.$el.find(".dd_snippet_settings .dd_background_manager").append("<span class='dd_image_background'><i class='fa fa-picture-o'></i></span><input type='file' class='image_input' style='display: none;'/>"),this.$el.find(".dd_snippet_settings .dd_background_manager").append("<br/><input type=range min=0 max=60 value=0 class='dd_snippet_padding'>")},b.prototype.showSettings=function(){return this.$el.find(".dd_snippet_settings").show(200)},b.prototype.hideSettings=function(){return this.$el.find(".dd_snippet_settings").hide(100)},b.prototype.changeColor=function(a){return this.$el.css("background","#"+$(a.target).data("color")),this.hideSettings()},b.prototype.imageBackgroundFileSelector=function(a){return a.stopPropagation(),this.$el.find(".image_input").trigger("click")},b.prototype.uploadBackgroundImage=function(a){var b,c,d;return a.target.files&&a.target.files[0]?(b=a.target.files[0],b.type.match("image.*")&&(d=new FileReader,d.onload=function(a){return function(b){return a.$el.css("background","url("+b.target.result+") no-repeat center center",200)}}(this),d.readAsDataURL(b)),window.FormData?(c=new FormData,c.append("source",b),window.app.saveImageCallback(c,function(a){return function(b){return b&&(a.$el.css("background","url("+b+") no-repeat center center"),a.$el.css("background-size","cover")),a.hideSettings()}}(this))):alert("Type de fichier non autoris√©")):void 0},b.prototype.updatePadding=function(a){return a.preventDefault(),a.stopPropagation(),this.$el.css("padding",$(a.target).val()+"px 0")},b.prototype.parseSnippet=function(){return this.$el.find(".dd_text").each(function(){return new DapperDoe.Content.Text({el:$(this)})}),this.$el.find("img").each(function(){return new DapperDoe.Content.Image({el:$(this)})})},b.prototype.destroy=function(){return confirm("Are you sure you want to destroy this snippet?")?this.$el.remove():void 0},b}(),DapperDoe.AppView=function(){function b(b){this.addSnippet=a(this.addSnippet,this),this.$el=b.el,this.$el.addClass("dd_top_element"),this.addTools(),this.$el.sortable({items:".dd_snippet",forcePlaceholderSize:!0,axis:"y",receive:this.addSnippet,handle:".snippet_mover"}),this.events(),this.parsePage()}return b.prototype.events=function(){return $("body").bind("click",function(){return function(){return window.app.textToolbar.hide()}}(this)),this.$el.bind("click",function(){return function(){return window.app.textToolbar.hide()}}(this))},b.prototype.addSnippet=function(a,b){var c,d;return d=Math.ceil(1e5*Math.random()),c=d=Math.ceil(1e5*Math.random()),$(b.helper).attr("id","snippet_"+c),$(b.helper).removeAttr("style"),$(b.item).trigger("addSnippet",{element:$("#snippet_"+c)})},b.prototype.addTools=function(){return $("body").append("<div class='dd_loader'><i class='fa fa-circle-o-notch fa-spin'></i></div>")},b.prototype.parsePage=function(){return this.$el.find(".dd_snippet").each(function(a,b){return new DapperDoe.Snippet({el:$(b)})})},b.prototype.getHtml=function(){var a;return a=this.$el.clone(),$(a).find(".dd_ui").remove(),$(a).find(".ui-draggable, .ui-draggable-handle").removeClass("ui-draggable ui-draggable-handle"),$(a).find(".rangySelectionBoundary").remove(),$(a).find("*[contenteditable=true]").removeAttr("contenteditable"),$(a).find(".dd_image_wrapper").each(function(){return $(this).find("img").appendTo($(this).parent()),$(this).remove()}),$(a).find(".dd_text .dd_text_content").each(function(){return $(this).children().appendTo($(this).parent()),$(this).remove()}),a.html().replace(/(\r\n|\n|\r|\t)/gm,"").replace(/<script>/gi,"").replace(/<\/script>/gi,"")},b.prototype.startLoader=function(){return $(".dd_loader").show()},b.prototype.stopLoader=function(){return $(".dd_loader").hide()},b}()}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b},c=function(a,b){return function(){return a.apply(b,arguments)}};DapperDoe.Content=function(){function a(a){this.$el=a.el,this.$el.bind("click",function(a){return a.stopPropagation()})}return a}(),DapperDoe.Toolbar=function(){function a(){this.$el=$("<div></div>"),this.$el.bind("click",function(a){return a.stopPropagation()})}return a}(),DapperDoe.Tools=function(){function a(){}return a}(),DapperDoe.Content.Text=function(a){function c(a){c.__super__.constructor.call(this,a),this.$el.attr("contenteditable","true"),this.events(),this.$el.is("p, div, blockquote")&&0===this.$el.children().length?this.$el.wrapInner("<p></p>"):this.$el.is("h1, h2, h3, h4, h5, h6")&&0===this.$el.children().length&&this.$el.wrapInner("<div></div>")}return b(c,a),c.prototype.events=function(){return this.$el.bind("paste",function(a){return function(b){return a.handlePaste(b)}}(this)),this.$el.bind("dragover drop",function(a){return function(b){return a.preventDrag(b)}}(this)),this.$el.bind("mouseup",function(a){return function(){return a.openToolbar()}}(this)),this.$el.bind("keyup",function(a){return function(){return a.openToolbar()}}(this))},c.prototype.openToolbar=function(){var a;return window.app.textToolbar.hide(),a=rangy.getSelection().getRangeAt(0),a.startOffset!==a.endOffset?window.app.textToolbar.show():void 0},c.prototype.handlePaste=function(a){var b,c;return a.preventDefault(),c=(a.originalEvent||a).clipboardData.getData("text/plain")||prompt("Paste something.."),b=document.createElement("div"),b.innerHTML=c,document.execCommand("insertHtml",!1,b.textContent)},c.prototype.preventDrag=function(a){return a.preventDefault(),!1},c}(DapperDoe.Content),DapperDoe.Content.Image=function(a){function c(a){c.__super__.constructor.call(this,a),this.tools=new DapperDoe.Tools.Image({image:this.$el})}return b(c,a),c}(DapperDoe.Content),DapperDoe.Tools.Image=function(a){function d(a){this.uploadImage=c(this.uploadImage,this),this.$image=a.image,this.$image.wrap('<div class="dd_image_wrapper"></div>'),this.$el=this.$image.parent(".dd_image_wrapper"),this.$el.append(this.html),this.$tools=this.$el.find(".dd_tools"),this.positionTools(),this.$tools.hide(),this.events()}return b(d,a),d.prototype.events=function(){return this.$el.find(".image_upload").bind("click",function(a){return function(){return a.selectFile()}}(this)),this.$el.bind("mouseover",function(a){return function(){return a.$tools.show()}}(this)),this.$el.bind("mouseout",function(a){return function(){return a.$tools.hide()}}(this)),this.$el.find(".image_input").bind("change",function(a){return function(b){return a.uploadImage(b)}}(this))},d.prototype.selectFile=function(){return this.$tools.find(".image_input").trigger("click")},d.prototype.uploadImage=function(a){var b,c,d;return a.target.files&&a.target.files[0]?(b=a.target.files[0],b.type.match("image.*")&&(d=new FileReader,d.onload=function(a){return function(b){return a.$image.attr("src",b.target.result),a.positionTools()}}(this),d.readAsDataURL(b)),window.FormData?(c=new FormData,c.append("source",b),window.app.saveImageCallback(c,function(a){return function(b){return b?a.$image.attr("src",b):void 0}}(this))):alert("Type de fichier non autoris√©")):void 0},d.prototype.positionTools=function(){return this.$tools.css("left",this.$image.width()/2-this.$el.find(".dd_tools").width()/2),this.$tools.css("top",this.$image.height()/2-this.$el.find(".dd_tools").height()/2)},d.prototype.remove=function(){return this.$image.parent(".dd_image_wrapper").find("div").remove(),this.$image.unwrap()},d.prototype.html=function(){return"<span class='dd_tools dd_ui'> <!--<i class='image_link fa fa-link'></i><br/>--> <i class='image_upload fa fa-image'></i> <input type='file' class='image_input' style='display: none;'/> </span>"},d}(DapperDoe.Tools),DapperDoe.Toolbar.Text=function(a){function d(a){this.applyForeColor=c(this.applyForeColor,this),this.editText=c(this.editText,this),d.__super__.constructor.call(this,a),this.$el.html(this.html),$(window.app.topElement).append(this.$el),this.toolbarWidth=this.$el.find(".dd_toolbar").width(),this.toolbarHeight=this.$el.find(".dd_toolbar").height(),this.$el.hide(),this.events()}return b(d,a),d.prototype.events=function(){return this.$el.find("button").bind("click",function(a){return function(b){return a.editText(b)}}(this))},d.prototype.hide=function(){return this.$el.hide(),this.hideSubToolbar()},d.prototype.hideSubToolbar=function(){return window.app.textSubToolbarColor.hide(),window.app.textSubToolbarUrl.hide()},d.prototype.show=function(){var a,b,c;return this.$el.hide(),a=rangy.getSelection().getRangeAt(0).getBoundingClientRect(),a.bottom>0?(c=a.top-10,b=a.left+a.width/2-this.toolbarWidth/2,10>b&&(b=10),b+this.toolbarWidth>$(document).width()-10&&(b=$(document).width()-10-this.toolbarWidth),this.$el.find(".dd_toolbar").css("bottom",$(window.app.topElement).height()-c-$(window).scrollTop()),this.$el.find(".dd_toolbar").css("left",b),this.$el.show()):void 0},d.prototype.editText=function(a){var b;switch(window.app.lastSel&&rangy.removeMarkers(window.app.lastSel),window.app.lastSel=rangy.saveSelection(),b=$(a.currentTarget).data("action"),this.hideSubToolbar(),b){case"bold":document.execCommand("bold",!1,null);break;case"italic":document.execCommand("italic",!1,null);break;case"underline":document.execCommand("underline",!1,null);break;case"text-color":window.app.textSubToolbarColor.show(this.applyForeColor);break;case"align-left":document.execCommand("justifyLeft",!1,null);break;case"align-center":document.execCommand("justifyCenter",!1,null);break;case"align-right":document.execCommand("justifyRight",!1,null);break;case"link":window.app.textSubToolbarUrl.show();break;case"unlink":document.execCommand("unlink",!1,null);break;case"clear":document.execCommand("removeFormat",!1,null),document.execCommand("unlink",!1,null);break;case"undo":document.execCommand("undo",!1,null)}return this.show()},d.prototype.html=function(){return $("<div class='dd_toolbar dd_ui'> <div class='dd_sub_toolbar'></div> <button data-action='bold'><i class='fa fa-bold'></i></button> <button data-action='italic'><i class='fa fa-italic'></i></button> <button data-action='underline'><i class='fa fa-underline'></i></button> <button data-action='text-color'><i class='fa fa-tint'></i></button> <button data-action='align-left'><i class='fa fa-align-left'></i></button> <button data-action='align-center'><i class='fa fa-align-center'></i></button> <button data-action='align-right'><i class='fa fa-align-right'></i></button> <button data-action='link'><i class='fa fa-link'></i></button> <button data-action='unlink'><i class='fa fa-unlink'></i></button> <button data-action='clear'><i class='fa fa-eraser'></i></button> <button data-action='undo'><i class='fa fa-undo'></i></button> </div>")},d.prototype.applyForeColor=function(a){return rangy.restoreSelection(window.app.lastSel),document.execCommand("foreColor",!1,a)},d}(DapperDoe.Toolbar),DapperDoe.TextSubToolbar=function(){function a(){this.$el=window.app.textToolbar.$el.find(".dd_sub_toolbar"),this.$el.hide(),this.$el.append(this.html()),this.events()}return a.prototype.events=function(){return this.$el.bind("click",function(a){return function(b){return a.stopPropagation(b)}}(this)),this.$el.find(".dd_submit").bind("click",function(a){return function(b){return a.doAction(b)}}(this))},a.prototype.show=function(a,b,c){return this.callback=b,c&&this.$el.find(".dd_sub_toolbar_content").hide(),this.$el.find(".dd_toolbar_"+a).show(),this.$el.slideDown(200)},a.prototype.doAction=function(a){return a.stopPropagation()},a.prototype.hide=function(){return $(".dd_toolbar button").removeClass("active"),this.$el.hide()},a.prototype.stopPropagation=function(a){return a.stopPropagation()},a.prototype.html=function(){return""},a}(),DapperDoe.TextSubToolbar.Color=function(a){function d(a){this.html=c(this.html,this),d.__super__.constructor.call(this,a)}return b(d,a),d.prototype.events=function(){return d.__super__.events.call(this),this.$el.find(".color").bind("click",function(a){return function(b){return a.doAction(b)}}(this))},d.prototype.stopPropagation=function(a){return a.stopPropagation()},d.prototype.doAction=function(a){var b;return a.stopPropagation(),b=$(a.target).data("color"),this.hide(a),this.callback(b)},d.prototype.hide=function(){return this.$el.find(".dd_toolbar_color").hide()},d.prototype.show=function(a,b){return d.__super__.show.call(this,"color",a,!b),b?void 0:$(".dd_toolbar button[data-action=text-color]").addClass("active")},d.prototype.html=function(){var a,b,c,d,e,f,g;for(a=$("<div class='dd_sub_toolbar_content dd_toolbar_color'></div>"),d=window.app.colorPalette,e=window.app.textToolbar.toolbarWidth/d.length,c=Math.round(e-4),f=0,g=d.length;g>f;f++)b=d[f],a.append("<span class='color' style='background: #"+b+"; width: "+c+"px; height: "+c+"px;' data-color='"+b+"'></span>");return a},d}(DapperDoe.TextSubToolbar),DapperDoe.TextSubToolbar.Url=function(a){function d(a){this.manageLinkColor=c(this.manageLinkColor,this),d.__super__.constructor.call(this,a),this.$el.find(".dd_link_color").bind("click",this.manageLinkColor),this.linkColor="fff"}return b(d,a),d.prototype.manageLinkColor=function(){return window.app.textSubToolbarColor.$el.find(".dd_toolbar_color").is(":visible")?window.app.textSubToolbarColor.hide():window.app.textSubToolbarColor.show(function(a){return window.app.textSubToolbarUrl.linkColor=a,this.$el.find(".dd_link_color").css("background","#"+a)},!0)},d.prototype.doAction=function(a){var b,c,d,e,f;if(a.stopPropagation(),this.url=this.$el.find(".dd_url").val(),this.blank=this.$el.find(".dd_blank").is(":checked"),this.button=this.$el.find(".dd_button").is(":checked"),rangy.restoreSelection(app.lastSel),this.link=document.execCommand("createLink",!1,this.url),this.blank&&rangy.getSelection().getRangeAt(0).commonAncestorContainer.parentNode.setAttribute("target","_blank"),this.button?rangy.getSelection().getRangeAt(0).commonAncestorContainer.parentNode.setAttribute("style","background: #"+this.linkColor+";"):rangy.getSelection().getRangeAt(0).commonAncestorContainer.parentNode.setAttribute("style","color: #"+this.linkColor+";"),this.button){c=window.app.buttonClass,f=window.app.buttonOptions;for(d in f)e=f[d],c+=" "+this.$el.find("input[name="+d+"]:checked").val();b=rangy.createCssClassApplier(c,{normalize:!0,elementTagName:"a"}),b.toggleSelection()}return this.hide(a)},d.prototype.show=function(){return $(".dd_toolbar button[data-action=link]").addClass("active"),d.__super__.show.call(this,"url",function(){return console.log("")},!0),this.$el.find(".dd_link_color").css("background","#fff")},d.prototype.html=function(){var a,b,c,d,e,f;a=$("<div class='dd_sub_toolbar_content dd_toolbar_url'> <input type='text' placeholder='Url' class='dd_url' /> <span class='dd_link_color'></span> <div class='dd_submit'><i class='fa fa-check'></i></div> <div class='clearfix'></div> <div class='dd_url_options'> <label>_blank <input type='checkbox' class='dd_blank'/></label> <label>Button <input type='checkbox' class='dd_button'/></label> </div> </div>"),f=window.app.buttonOptions;for(b in f){e=f[b];for(c in e)d=e[c],a.find(".dd_url_options").append("<label> "+d+" <input type='radio' name='"+b+"' value='"+c+"' /> </label>");a.find("input[name="+b+"]:first").attr("checked",!0)}return a},d}(DapperDoe.TextSubToolbar),DapperDoe.Modal=function(){function a(){this.$el=this.html(),$(window.app.topElement).append(this.$el),this.events()}return a.prototype.events=function(){return this.$el.bind("click",function(a){return function(b){return a.stopPropagation(b)}}(this)),this.$el.find(".dd_submit_modal").bind("click",function(a){return function(b){return a.doAction(b)}}(this)),this.$el.find(".dd_close_modal").bind("click",function(a){return function(b){return a.closeModal(b)}}(this))},a.prototype.doAction=function(a){return a.stopPropagation()},a.prototype.closeModal=function(a){return a.stopPropagation(),this.$el.remove()},a.prototype.stopPropagation=function(a){return a.stopPropagation()},a.prototype.html=function(){return $("<div class='dd_modal_overlay'> <div class='dd_modal'> <span class='dd_close_modal'><i class='fa fa-close'></i></span> <div class='dd_content'> </div> </div> </div>")},a}(),DapperDoe.Modal.Color=function(a){function d(a){this.html=c(this.html,this),d.__super__.constructor.call(this,a),this.callback=a.callback,this.events()}return b(d,a),d.prototype.events=function(){return d.__super__.events.call(this),this.$el.find(".color").bind("click",function(a){return function(b){return a.doAction(b)}}(this))},d.prototype.stopPropagation=function(a){return a.stopPropagation()},d.prototype.doAction=function(a){var b;return a.stopPropagation(),b=$(a.target).data("color"),this.closeModal(a),this.callback(b)},d.prototype.colorLuminance=function(a,b){var c,d,e,f;for(a=String(a).replace(/[^0-9a-f]/gi,""),a.length<6&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),b=b||0,e="",d=f=0;2>=f;d=f+=1)c=parseInt(a.substr(2*d,2),16),c=Math.round(Math.min(Math.max(0,c+c*b),255)).toString(16),e+=("00"+c).substr(c.length);return e},d.prototype.html=function(){var a,b,c,e,f,g,h;a=d.__super__.html.call(this),a.find(".dd_content").append("<table class='dd_color_palette'></table>"),h=window.app.colorPalette;for(b in h)for(e=h[b],a.find(".dd_color_palette").append("<tr class='base_color_"+b+"'></tr>"),f=g=-2;3>=g;f=g+=1)c=this.colorLuminance(b,.3*f),a.find(".dd_color_palette .base_color_"+b).append("<td class='color' style='background: #"+c+";' data-color='"+c+"'></td>");return a},d}(DapperDoe.Modal),DapperDoe.Modal.Url=function(a){function c(a){c.__super__.constructor.call(this,a)}return b(c,a),c.prototype.doAction=function(a){var b,c,d,e,f;if(a.stopPropagation(),this.url=this.$el.find(".dd_url").val(),this.blank=this.$el.find(".dd_blank").is(":checked"),this.button=this.$el.find(".dd_button").is(":checked"),rangy.restoreSelection(app.lastSel),this.link=document.execCommand("createLink",!1,this.url),this.blank&&rangy.getSelection().getRangeAt(0).commonAncestorContainer.parentNode.setAttribute("target","_blank"),this.button){c=window.app.buttonClass,f=window.app.buttonOptions;for(d in f)e=f[d],c+=" "+this.$el.find("input[name="+d+"]:checked").val();b=rangy.createCssClassApplier(c,{normalize:!0,elementTagName:"a"}),b.toggleSelection()}return this.closeModal(a)},c.prototype.html=function(){var a,b,d,e,f,g;a=c.__super__.html.call(this),a.find(".dd_content").append("<input type='text' placeholder='Url' class='dd_url' /> <div class='dd_options'> <label> Target blank <input type='checkbox' class='dd_blank'/> </label> <div class='dd_button_options'> <b>Button <input type='checkbox' class='dd_button'/></b> </div> </div> <input type='submit' value='OK' class='dd_submit_modal'/>"),g=window.app.buttonOptions;for(b in g){f=g[b],a.find(".dd_button_options").append("<div class='dd_button_option "+b+"'></div>");for(d in f)e=f[d],a.find(".dd_button_options .dd_button_option."+b).append("<label> "+e+" <input type='radio' name='"+b+"' value='"+d+"' /> </label>");a.find("input[name="+b+"]:first").attr("checked",!0)}return a},c}(DapperDoe.Modal)}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};DapperDoe.App=function(){function b(b){this.buildApp=a(this.buildApp,this);var c;c={buttonClass:"btn",colorPalette:["eb6566","f4794d","fbd546","599e7f","3e8871","618eb1","0d6eb2","595d8e","b172ab","792360","ac8b66","8b9291","eeeeee","ffffff"],saveImageCallback:function(a,b){return console.log(a),b(!1)}},c=$.extend(c,b),this.snippetsPath=c.snippetsPath,this.buttonClass=c.buttonClass,this.buttonOptions=c.buttonOptions,this.colorPalette=c.colorPalette,this.savePageCallback=c.savePageCallback,this.saveImageCallback=c.saveImageCallback,this.topElement=c.topElement,this.template=new DapperDoe.Template({topElement:this.topElement,path:this.snippetsPath,callback:this.buildApp})}return b.prototype.buildApp=function(){return this.initTopElement(),this.buildUI()},b.prototype.buildUI=function(){return this.sidebar=new DapperDoe.Sidebar({collection:this.template.snippetsPreviews}),this.textToolbar=new DapperDoe.Toolbar.Text,this.textSubToolbarUrl=new DapperDoe.TextSubToolbar.Url,this.textSubToolbarColor=new DapperDoe.TextSubToolbar.Color},b.prototype.initTopElement=function(){return this.view=new DapperDoe.AppView({el:this.topElement})},b.prototype.getHtml=function(){return this.view.getHtml()},b}()}.call(this),window.rangy=function(){function a(a,b){var c=typeof a[b];return"function"==c||!("object"!=c||!a[b])||"unknown"==c}function b(a,b){return!("object"!=typeof a[b]||!a[b])}function c(a,b){return"undefined"!=typeof a[b]}function d(a){return function(b,c){for(var d=c.length;d--;)if(!a(b,c[d]))return!1;return!0}}function e(a){return a&&m(a,l)&&o(a,k)}function f(a){window.alert("Rangy not supported in your browser. Reason: "+a),p.initialized=!0,p.supported=!1}function g(){if(!p.initialized){var c,d=!1,g=!1;for(a(document,"createRange")&&(c=document.createRange(),m(c,j)&&o(c,i)&&(d=!0),c.detach()),(c=b(document,"body")?document.body:document.getElementsByTagName("body")[0])&&a(c,"createTextRange")&&(c=c.createTextRange(),e(c)&&(g=!0)),!d&&!g&&f("Neither Range nor TextRange are implemented"),p.initialized=!0,p.features={implementsDomRange:d,implementsTextRange:g},d=r.concat(q),g=0,c=d.length;c>g;++g)try{d[g](p)}catch(h){b(window,"console")&&a(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",h)}}}function h(a){this.name=a,this.supported=this.initialized=!1}var i=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],j=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],k=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],l=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],m=d(a),n=d(b),o=d(c),p={version:"1.2.3",initialized:!1,supported:!0,util:{isHostMethod:a,isHostObject:b,isHostProperty:c,areHostMethods:m,areHostObjects:n,areHostProperties:o,isTextRange:e},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};p.fail=f,p.warn=function(a){a="Rangy warning: "+a,p.config.alertOnWarn?window.alert(a):"undefined"!=typeof window.console&&"undefined"!=typeof window.console.log&&window.console.log(a)},{}.hasOwnProperty?p.util.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}:f("hasOwnProperty not supported");var q=[],r=[];p.init=g,p.addInitListener=function(a){p.initialized?a(p):q.push(a)};var s=[];p.addCreateMissingNativeApiListener=function(a){s.push(a)},p.createMissingNativeApi=function(a){a=a||window,g();for(var b=0,c=s.length;c>b;++b)s[b](a)},h.prototype.fail=function(a){throw this.initialized=!0,this.supported=!1,Error("Module '"+this.name+"' failed to load: "+a)},h.prototype.warn=function(a){p.warn("Module "+this.name+": "+a)},h.prototype.createError=function(a){return Error("Error in Rangy "+this.name+" module: "+a)},p.createModule=function(a,b){var c=new h(a);p.modules[a]=c,r.push(function(a){b(a,c),c.initialized=!0,c.supported=!0})},p.requireModules=function(a){for(var b,c,d=0,e=a.length;e>d;++d){if(c=a[d],b=p.modules[c],!(b&&b instanceof h))throw Error("Module '"+c+"' not found");if(!b.supported)throw Error("Module '"+c+"' not supported")}};var t=!1;if(n=function(){t||(t=!0,p.initialized||g())},"undefined"==typeof window)f("No window found");else{if("undefined"!=typeof document)return a(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",n,!1),a(window,"addEventListener")?window.addEventListener("load",n,!1):a(window,"attachEvent")?window.attachEvent("onload",n):f("Window does not have required addEventListener or attachEvent method"),p;f("No document found")}}(),rangy.createModule("DomUtil",function(a,b){function c(a){for(var b=0;a=a.previousSibling;)b++;return b}function d(a,b){var c,d=[];for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(o(d,c))return c;return null}function e(a,b,c){for(c=c?a:a.parentNode;c;){if(a=c.parentNode,a===b)return c;c=a}return null}function f(a){return a=a.nodeType,3==a||4==a||8==a}function g(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function h(a){if(9==a.nodeType)return a;if("undefined"!=typeof a.ownerDocument)return a.ownerDocument;if("undefined"!=typeof a.document)return a.document;if(a.parentNode)return h(a.parentNode);throw Error("getDocument: no document found for node")}function i(a){return a?f(a)?'"'+a.data+'"':1==a.nodeType?"<"+a.nodeName+(a.id?' id="'+a.id+'"':"")+">["+a.childNodes.length+"]":a.nodeName:"[No node]"}function j(a){this._next=this.root=a}function k(a,b){this.node=a,this.offset=b}function l(a){this.code=this[a],this.codeName=a,this.message="DOMException: "+this.codeName}var m=a.util;m.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method"),m.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var n=document.createElement("div");m.areHostMethods(n,["insertBefore","appendChild","cloneNode"])||b.fail("Incomplete Element implementation"),m.isHostProperty(n,"innerHTML")||b.fail("Element is missing innerHTML property"),n=document.createTextNode("test"),m.areHostMethods(n,["splitText","deleteData","insertData","appendData","cloneNode"])||b.fail("Incomplete Text Node implementation");var o=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1};j.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a,b=this._current=this._next;if(this._current)if(a=b.firstChild)this._next=a;else{for(a=null;b!==this.root&&!(a=b.nextSibling);)b=b.parentNode;this._next=a}return this._current},detach:function(){this._current=this._next=this.root=null}},k.prototype={equals:function(a){return this.node===a.node&this.offset==a.offset},inspect:function(){return"[DomPosition("+i(this.node)+":"+this.offset+")]"}},l.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},l.prototype.toString=function(){return this.message},a.dom={arrayContains:o,isHtmlNamespace:function(a){var b;return"undefined"==typeof a.namespaceURI||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b},parentElement:function(a){return a=a.parentNode,1==a.nodeType?a:null},getNodeIndex:c,getNodeLength:function(a){var b;return f(a)?a.length:(b=a.childNodes)?b.length:0},getCommonAncestor:d,isAncestorOf:function(a,b,c){for(b=c?b:b.parentNode;b;){if(b===a)return!0;b=b.parentNode}return!1},getClosestAncestorIn:e,isCharacterDataNode:f,insertAfter:g,splitDataNode:function(a,b){var c=a.cloneNode(!1);return c.deleteData(0,b),a.deleteData(b,a.length-b),g(c,a),c},getDocument:h,getWindow:function(a){if(a=h(a),"undefined"!=typeof a.defaultView)return a.defaultView;if("undefined"!=typeof a.parentWindow)return a.parentWindow;throw Error("Cannot get a window object for node")},getIframeWindow:function(a){if("undefined"!=typeof a.contentWindow)return a.contentWindow;if("undefined"!=typeof a.contentDocument)return a.contentDocument.defaultView;throw Error("getIframeWindow: No Window object found for iframe element")},getIframeDocument:function(a){if("undefined"!=typeof a.contentDocument)return a.contentDocument;
if("undefined"!=typeof a.contentWindow)return a.contentWindow.document;throw Error("getIframeWindow: No Document object found for iframe element")},getBody:function(a){return m.isHostObject(a,"body")?a.body:a.getElementsByTagName("body")[0]},getRootContainer:function(a){for(var b;b=a.parentNode;)a=b;return a},comparePoints:function(a,b,f,g){var h;if(a==f)return b===g?0:g>b?-1:1;if(h=e(f,a,!0))return b<=c(h)?-1:1;if(h=e(a,f,!0))return c(h)<g?-1:1;if(b=d(a,f),a=a===b?b:e(a,b,!0),f=f===b?b:e(f,b,!0),a===f)throw Error("comparePoints got to case 4 and childA and childB are the same!");for(b=b.firstChild;b;){if(b===a)return-1;if(b===f)return 1;b=b.nextSibling}throw Error("Should not be here!")},inspectNode:i,fragmentFromNodeChildren:function(a){for(var b,c=h(a).createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c},createIterator:function(a){return new j(a)},DomPosition:k},a.DOMException=l}),rangy.createModule("DomRange",function(a){function b(a,b){return 3!=a.nodeType&&(I.isAncestorOf(a,b.startContainer,!0)||I.isAncestorOf(a,b.endContainer,!0))}function c(a){return I.getDocument(a.startContainer)}function d(a,b,c){if(b=a._listeners[b])for(var d=0,e=b.length;e>d;++d)b[d].call(a,{target:a,args:c})}function e(a){return new J(a.parentNode,I.getNodeIndex(a))}function f(a){return new J(a.parentNode,I.getNodeIndex(a)+1)}function g(a,b,c){var d=11==a.nodeType?a.firstChild:a;return I.isCharacterDataNode(b)?c==b.length?I.insertAfter(a,b):b.parentNode.insertBefore(a,0==c?b:I.splitDataNode(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]),d}function h(a){for(var b,d,e=c(a.range).createDocumentFragment();d=a.next();){if(b=a.isPartiallySelectedSubtree(),d=d.cloneNode(!b),b&&(b=a.getSubtreeIterator(),d.appendChild(h(b)),b.detach(!0)),10==d.nodeType)throw new K("HIERARCHY_REQUEST_ERR");e.appendChild(d)}return e}function i(a,b,c){var d,e;for(c=c||{stop:!1};d=a.next();)if(a.isPartiallySelectedSubtree()){if(b(d)===!1)return void(c.stop=!0);if(d=a.getSubtreeIterator(),i(d,b,c),d.detach(!0),c.stop)return}else for(d=I.createIterator(d);e=d.next();)if(b(e)===!1)return void(c.stop=!0)}function j(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),j(b),b.detach(!0)):a.remove()}function k(a){for(var b,d,e=c(a.range).createDocumentFragment();b=a.next();){if(a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),d=a.getSubtreeIterator(),b.appendChild(k(d)),d.detach(!0)):a.remove(),10==b.nodeType)throw new K("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function l(a,b,c){var d,e=!(!b||!b.length),f=!!c;e&&(d=RegExp("^("+b.join("|")+")$"));var g=[];return i(new n(a,!1),function(a){e&&!d.test(a.nodeType)||f&&!c(a)||g.push(a)}),g}function m(a){return"["+("undefined"==typeof a.getName?"Range":a.getName())+"("+I.inspectNode(a.startContainer)+":"+a.startOffset+", "+I.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function n(a,b){if(this.range=a,this.clonePartiallySelectedTextNodes=b,!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&I.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==c||I.isCharacterDataNode(this.sc)?I.getClosestAncestorIn(this.sc,c,!0):this.sc.childNodes[this.so],this._last=this.ec!==c||I.isCharacterDataNode(this.ec)?I.getClosestAncestorIn(this.ec,c,!0):this.ec.childNodes[this.eo-1])}}function o(a){this.code=this[a],this.codeName=a,this.message="RangeException: "+this.codeName}function p(a,b,c){this.nodes=l(a,b,c),this._next=this.nodes[0],this._position=0}function q(a){return function(b,c){for(var d,e=c?b:b.parentNode;e;){if(d=e.nodeType,I.arrayContains(a,d))return e;e=e.parentNode}return null}}function r(a,b){if(S(a,b))throw new o("INVALID_NODE_TYPE_ERR")}function s(a){if(!a.startContainer)throw new K("INVALID_STATE_ERR")}function t(a,b){if(!I.arrayContains(b,a.nodeType))throw new o("INVALID_NODE_TYPE_ERR")}function u(a,b){if(0>b||b>(I.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new K("INDEX_SIZE_ERR")}function v(a,b){if(Q(a,!0)!==Q(b,!0))throw new K("WRONG_DOCUMENT_ERR")}function w(a){if(R(a,!0))throw new K("NO_MODIFICATION_ALLOWED_ERR")}function x(a,b){if(!a)throw new K(b)}function y(a){return!!a.startContainer&&!!a.endContainer&&!(!I.arrayContains(M,a.startContainer.nodeType)&&!Q(a.startContainer,!0))&&!(!I.arrayContains(M,a.endContainer.nodeType)&&!Q(a.endContainer,!0))&&a.startOffset<=(I.isCharacterDataNode(a.startContainer)?a.startContainer.length:a.startContainer.childNodes.length)&&a.endOffset<=(I.isCharacterDataNode(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)}function z(a){if(s(a),!y(a))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")")}function A(){}function B(a){a.START_TO_START=X,a.START_TO_END=Y,a.END_TO_END=Z,a.END_TO_START=$,a.NODE_BEFORE=_,a.NODE_AFTER=ab,a.NODE_BEFORE_AND_AFTER=bb,a.NODE_INSIDE=cb}function C(a){B(a),B(a.prototype)}function D(a,b){return function(){z(this);var c=this.startContainer,d=this.startOffset,e=this.commonAncestorContainer,g=new n(this,!0);return c!==e&&(c=I.getClosestAncestorIn(c,e,!0),d=f(c),c=d.node,d=d.offset),i(g,w),g.reset(),e=a(g),g.detach(),b(this,c,d,c,d),e}}function E(c,d,g){function h(a,b){return function(c){s(this),t(c,L),t(P(c),M),c=(a?e:f)(c),(b?i:l)(this,c.node,c.offset)}}function i(a,b,c){var e=a.endContainer,f=a.endOffset;(b!==a.startContainer||c!==a.startOffset)&&((P(b)!=P(e)||1==I.comparePoints(b,c,e,f))&&(e=b,f=c),d(a,b,c,e,f))}function l(a,b,c){var e=a.startContainer,f=a.startOffset;(b!==a.endContainer||c!==a.endOffset)&&((P(b)!=P(e)||-1==I.comparePoints(b,c,e,f))&&(e=b,f=c),d(a,e,f,b,c))}c.prototype=new A,a.util.extend(c.prototype,{setStart:function(a,b){s(this),r(a,!0),u(a,b),i(this,a,b)},setEnd:function(a,b){s(this),r(a,!0),u(a,b),l(this,a,b)},setStartBefore:h(!0,!0),setStartAfter:h(!1,!0),setEndBefore:h(!0,!1),setEndAfter:h(!1,!1),collapse:function(a){z(this),a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){s(this),r(a,!0),d(this,a,0,a,I.getNodeLength(a))},selectNode:function(a){s(this),r(a,!1),t(a,L);var b=e(a);a=f(a),d(this,b.node,b.offset,a.node,a.offset)},extractContents:D(k,d),deleteContents:D(j,d),canSurroundContents:function(){z(this),w(this.startContainer),w(this.endContainer);var a=new n(this,!0),c=a._first&&b(a._first,this)||a._last&&b(a._last,this);return a.detach(),!c},detach:function(){g(this)},splitBoundaries:function(){z(this);var a=this.startContainer,b=this.startOffset,c=this.endContainer,e=this.endOffset,f=a===c;I.isCharacterDataNode(c)&&e>0&&e<c.length&&I.splitDataNode(c,e),I.isCharacterDataNode(a)&&b>0&&b<a.length&&(a=I.splitDataNode(a,b),f?(e-=b,c=a):c==a.parentNode&&e>=I.getNodeIndex(a)&&e++,b=0),d(this,a,b,c,e)},normalizeBoundaries:function(){z(this);var a=this.startContainer,b=this.startOffset,c=this.endContainer,e=this.endOffset,f=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(c=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},g=function(d){var f=d.previousSibling;if(f&&f.nodeType==d.nodeType){a=d;var g=d.length;b=f.length,d.insertData(0,f.data),f.parentNode.removeChild(f),a==c?(e+=b,c=a):c==d.parentNode&&(f=I.getNodeIndex(d),e==f?(c=d,e=g):e>f&&e--)}},h=!0;I.isCharacterDataNode(c)?c.length==e&&f(c):(e>0&&(h=c.childNodes[e-1])&&I.isCharacterDataNode(h)&&f(h),h=!this.collapsed),h?I.isCharacterDataNode(a)?0==b&&g(a):b<a.childNodes.length&&(f=a.childNodes[b])&&I.isCharacterDataNode(f)&&g(f):(a=c,b=e),d(this,a,b,c,e)},collapseToPoint:function(a,b){s(this),r(a,!0),u(a,b),(a!==this.startContainer||b!==this.startOffset||a!==this.endContainer||b!==this.endOffset)&&d(this,a,b,a,b)}}),C(c)}function F(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:I.getCommonAncestor(a.startContainer,a.endContainer)}function G(a,b,c,e,f){var g=a.startContainer!==b||a.startOffset!==c,h=a.endContainer!==e||a.endOffset!==f;a.startContainer=b,a.startOffset=c,a.endContainer=e,a.endOffset=f,F(a),d(a,"boundarychange",{startMoved:g,endMoved:h})}function H(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,this._listeners={boundarychange:[],detach:[]},F(this)}a.requireModules(["DomUtil"]);var I=a.dom,J=I.DomPosition,K=a.DOMException;n.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,I.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a,b,c=this._current;!I.isCharacterDataNode(c)||c!==this.sc&&c!==this.ec?c.parentNode&&c.parentNode.removeChild(c):(a=c===this.sc?this.so:0,b=c===this.ec?this.eo:c.length,a!=b&&c.deleteData(a,b-a))},isPartiallySelectedSubtree:function(){return b(this._current,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse();else{a=new H(c(this.range));var b=this._current,d=b,e=0,f=b,g=I.getNodeLength(b);I.isAncestorOf(b,this.sc,!0)&&(d=this.sc,e=this.so),I.isAncestorOf(b,this.ec,!0)&&(f=this.ec,g=this.eo),G(a,d,e,f,g)}return new n(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},o.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},o.prototype.toString=function(){return this.message},p.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){return this._current=this._next,this._next=this.nodes[++this._position],this._current},detach:function(){this._current=this._next=this.nodes=null}};var L=[1,3,4,5,7,8,10],M=[2,9,11],N=[1,3,4,5,7,8,10,11],O=[1,3,4,5,7,8],P=I.getRootContainer,Q=q([9,11]),R=q([5,6,10,12]),S=q([6,10,12]),T=document.createElement("style"),U=!1;try{T.innerHTML="<b>x</b>",U=3==T.firstChild.nodeType}catch(V){}a.features.htmlParsingConforms=U;var W=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],X=0,Y=1,Z=2,$=3,_=0,ab=1,bb=2,cb=3;A.prototype={attachListener:function(a,b){this._listeners[a].push(b)},compareBoundaryPoints:function(a,b){z(this),v(this.startContainer,b.startContainer);var c=a==$||a==X?"start":"end",d=a==Y||a==X?"start":"end";return I.comparePoints(this[c+"Container"],this[c+"Offset"],b[d+"Container"],b[d+"Offset"])},insertNode:function(a){if(z(this),t(a,N),w(this.startContainer),I.isAncestorOf(a,this.startContainer,!0))throw new K("HIERARCHY_REQUEST_ERR");this.setStartBefore(g(a,this.startContainer,this.startOffset))},cloneContents:function(){z(this);var a,b;return this.collapsed?c(this).createDocumentFragment():this.startContainer===this.endContainer&&I.isCharacterDataNode(this.startContainer)?(a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=c(this).createDocumentFragment(),b.appendChild(a),b):(b=new n(this,!0),a=h(b),b.detach(),a)},canSurroundContents:function(){z(this),w(this.startContainer),w(this.endContainer);var a=new n(this,!0),c=a._first&&b(a._first,this)||a._last&&b(a._last,this);return a.detach(),!c},surroundContents:function(a){if(t(a,O),!this.canSurroundContents())throw new o("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);g(a,this.startContainer,this.startOffset),a.appendChild(b),this.selectNode(a)},cloneRange:function(){z(this);for(var a,b=new H(c(this)),d=W.length;d--;)a=W[d],b[a]=this[a];return b},toString:function(){z(this);var a=this.startContainer;if(a===this.endContainer&&I.isCharacterDataNode(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[];return a=new n(this,!0),i(a,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)}),a.detach(),b.join("")},compareNode:function(a){z(this);var b=a.parentNode,c=I.getNodeIndex(a);if(!b)throw new K("NOT_FOUND_ERR");return a=this.comparePoint(b,c),b=this.comparePoint(b,c+1),0>a?b>0?bb:_:b>0?ab:cb},comparePoint:function(a,b){return z(this),x(a,"HIERARCHY_REQUEST_ERR"),v(a,this.startContainer),I.comparePoints(a,b,this.startContainer,this.startOffset)<0?-1:I.comparePoints(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:U?function(a){var b=this.startContainer,c=I.getDocument(b);if(!b)throw new K("INVALID_STATE_ERR");var d=null;return 1==b.nodeType?d=b:I.isCharacterDataNode(b)&&(d=I.parentElement(b)),d=null===d||"HTML"==d.nodeName&&I.isHtmlNamespace(I.getDocument(d).documentElement)&&I.isHtmlNamespace(d)?c.createElement("body"):d.cloneNode(!1),d.innerHTML=a,I.fragmentFromNodeChildren(d)}:function(a){s(this);var b=c(this).createElement("body");return b.innerHTML=a,I.fragmentFromNodeChildren(b)},toHtml:function(){z(this);var a=c(this).createElement("div");return a.appendChild(this.cloneContents()),a.innerHTML},intersectsNode:function(a,b){if(z(this),x(a,"NOT_FOUND_ERR"),I.getDocument(a)!==c(this))return!1;var d=a.parentNode,e=I.getNodeIndex(a);x(d,"NOT_FOUND_ERR");var f=I.comparePoints(d,e,this.endContainer,this.endOffset);return d=I.comparePoints(d,e+1,this.startContainer,this.startOffset),b?0>=f&&d>=0:0>f&&d>0},isPointInRange:function(a,b){return z(this),x(a,"HIERARCHY_REQUEST_ERR"),v(a,this.startContainer),I.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&I.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a,b){if(z(this),c(a)!=c(this))throw new K("WRONG_DOCUMENT_ERR");var d=I.comparePoints(this.startContainer,this.startOffset,a.endContainer,a.endOffset),e=I.comparePoints(this.endContainer,this.endOffset,a.startContainer,a.startOffset);return b?0>=d&&e>=0:0>d&&e>0},intersection:function(a){if(this.intersectsRange(a)){var b=I.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=I.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();return-1==b&&d.setStart(a.startContainer,a.startOffset),1==c&&d.setEnd(a.endContainer,a.endOffset),d}return null},union:function(a){if(this.intersectsRange(a,!0)){var b=this.cloneRange();return-1==I.comparePoints(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset),1==I.comparePoints(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset),b}throw new o("Ranges do not intersect")},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==cb},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,I.getNodeLength(a))<=0},containsRange:function(a){return this.intersection(a).equals(a)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);return c.length>0?(b.setStart(c[0],0),a=c.pop(),b.setEnd(a,a.length),a=this.containsRange(b),b.detach(),a):this.containsNodeContents(a)},createNodeIterator:function(a,b){return z(this),new p(this,a,b)},getNodes:function(a,b){return z(this),l(this,a,b)},getDocument:function(){return c(this)},collapseBefore:function(a){s(this),this.setEndBefore(a),this.collapse(!1)},collapseAfter:function(a){s(this),this.setStartAfter(a),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(a){return H.rangesEqual(this,a)},isValid:function(){return y(this)},inspect:function(){return m(this)}},E(H,G,function(a){s(a),a.startContainer=a.startOffset=a.endContainer=a.endOffset=null,a.collapsed=a.commonAncestorContainer=null,d(a,"detach",null),a._listeners=null}),a.rangePrototype=A.prototype,H.rangeProperties=W,H.RangeIterator=n,H.copyComparisonConstants=C,H.createPrototypeRange=E,H.inspect=m,H.getRangeDocument=c,H.rangesEqual=function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset},a.DomRange=H,a.RangeException=o}),rangy.createModule("WrappedRange",function(a){function b(a,b,c,d){var g=a.duplicate();g.collapse(c);var h=g.parentElement();if(e.isAncestorOf(b,h,!0)||(h=b),!h.canHaveHTML)return new f(h.parentNode,e.getNodeIndex(h));b=e.getDocument(h).createElement("span");var i,j=c?"StartToStart":"StartToEnd";do h.insertBefore(b,b.previousSibling),g.moveToElementText(b);while((i=g.compareEndPoints(j,a))>0&&b.previousSibling);if(j=b.nextSibling,-1==i&&j&&e.isCharacterDataNode(j)){if(g.setEndPoint(c?"EndToStart":"EndToEnd",a),/[\r\n]/.test(j.data))for(h=g.duplicate(),c=h.text.replace(/\r\n/g,"\r").length,c=h.moveStart("character",c);-1==h.compareEndPoints("StartToEnd",h);)c++,h.moveStart("character",1);else c=g.text.length;h=new f(j,c)}else j=(d||!c)&&b.previousSibling,h=(c=(d||c)&&b.nextSibling)&&e.isCharacterDataNode(c)?new f(c,0):j&&e.isCharacterDataNode(j)?new f(j,j.length):new f(h,e.getNodeIndex(b));return b.parentNode.removeChild(b),h}function c(a,b){var c,d,f=a.offset,g=e.getDocument(a.node),h=g.body.createTextRange(),i=e.isCharacterDataNode(a.node);return i?(c=a.node,d=c.parentNode):(c=a.node.childNodes,c=f<c.length?c[f]:null,d=a.node),g=g.createElement("span"),g.innerHTML="&#feff;",c?d.insertBefore(g,c):d.appendChild(g),h.moveToElementText(g),h.collapse(!b),d.removeChild(g),i&&h[b?"moveStart":"moveEnd"]("character",f),h}a.requireModules(["DomUtil","DomRange"]);var d,e=a.dom,f=e.DomPosition,g=a.DomRange;if(!a.features.implementsDomRange||a.features.implementsTextRange&&a.config.preferTextRange){if(a.features.implementsTextRange){d=function(a){this.textRange=a,this.refresh()},d.prototype=new g(document),d.prototype.refresh=function(){var a,c,d=this.textRange;a=d.parentElement();var f=d.duplicate();f.collapse(!0),c=f.parentElement(),f=d.duplicate(),f.collapse(!1),d=f.parentElement(),c=c==d?c:e.getCommonAncestor(c,d),c=c==a?c:e.getCommonAncestor(a,c),0==this.textRange.compareEndPoints("StartToEnd",this.textRange)?c=a=b(this.textRange,c,!0,!0):(a=b(this.textRange,c,!0,!1),c=b(this.textRange,c,!1,!1)),this.setStart(a.node,a.offset),this.setEnd(c.node,c.offset)},g.copyComparisonConstants(d);var h=function(){return this}();"undefined"==typeof h.Range&&(h.Range=d),a.createNativeRange=function(a){return a=a||document,a.body.createTextRange()}}}else!function(){function b(a){for(var b,c=i.length;c--;)b=i[c],a[b]=a.nativeRange[b]}var c,f,h,i=g.rangeProperties;d=function(a){if(!a)throw Error("Range must be specified");this.nativeRange=a,b(this)},g.createPrototypeRange(d,function(a,b,c,d,e){var f=a.endContainer!==d||a.endOffset!=e;(a.startContainer!==b||a.startOffset!=c||f)&&(a.setEnd(d,e),a.setStart(b,c))},function(a){a.nativeRange.detach(),a.detached=!0;for(var b,c=i.length;c--;)b=i[c],a[b]=null}),c=d.prototype,c.selectNode=function(a){this.nativeRange.selectNode(a),b(this)},c.deleteContents=function(){this.nativeRange.deleteContents(),b(this)},c.extractContents=function(){var a=this.nativeRange.extractContents();return b(this),a},c.cloneContents=function(){return this.nativeRange.cloneContents()},c.surroundContents=function(a){this.nativeRange.surroundContents(a),b(this)},c.collapse=function(a){this.nativeRange.collapse(a),b(this)},c.cloneRange=function(){return new d(this.nativeRange.cloneRange())},c.refresh=function(){b(this)},c.toString=function(){return this.nativeRange.toString()};var j=document.createTextNode("test");e.getBody(document).appendChild(j);var k=document.createRange();k.setStart(j,0),k.setEnd(j,0);try{k.setStart(j,1),f=!0,c.setStart=function(a,c){this.nativeRange.setStart(a,c),b(this)},c.setEnd=function(a,c){this.nativeRange.setEnd(a,c),b(this)},h=function(a){return function(c){this.nativeRange[a](c),b(this)}}}catch(l){f=!1,c.setStart=function(a,c){try{this.nativeRange.setStart(a,c)}catch(d){this.nativeRange.setEnd(a,c),this.nativeRange.setStart(a,c)}b(this)},c.setEnd=function(a,c){try{this.nativeRange.setEnd(a,c)}catch(d){this.nativeRange.setStart(a,c),this.nativeRange.setEnd(a,c)}b(this)},h=function(a,c){return function(d){try{this.nativeRange[a](d)}catch(e){this.nativeRange[c](d),this.nativeRange[a](d)}b(this)}}}c.setStartBefore=h("setStartBefore","setEndBefore"),c.setStartAfter=h("setStartAfter","setEndAfter"),c.setEndBefore=h("setEndBefore","setStartBefore"),c.setEndAfter=h("setEndAfter","setStartAfter"),k.selectNodeContents(j),c.selectNodeContents=k.startContainer==j&&k.endContainer==j&&0==k.startOffset&&k.endOffset==j.length?function(a){this.nativeRange.selectNodeContents(a),b(this)}:function(a){this.setStart(a,0),this.setEnd(a,g.getEndOffset(a))},k.selectNodeContents(j),k.setEnd(j,3),f=document.createRange(),f.selectNodeContents(j),f.setEnd(j,4),f.setStart(j,2),c.compareBoundaryPoints=-1==k.compareBoundaryPoints(k.START_TO_END,f)&1==k.compareBoundaryPoints(k.END_TO_START,f)?function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)},a.util.isHostMethod(k,"createContextualFragment")&&(c.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)}),e.getBody(document).removeChild(j),k.detach(),f.detach()}(),a.createNativeRange=function(a){return a=a||document,a.createRange()};a.features.implementsTextRange&&(d.rangeToTextRange=function(a){if(a.collapsed)return c(new f(a.startContainer,a.startOffset),!0);var b=c(new f(a.startContainer,a.startOffset),!0),d=c(new f(a.endContainer,a.endOffset),!1);return a=e.getDocument(a.startContainer).body.createTextRange(),a.setEndPoint("StartToStart",b),a.setEndPoint("EndToEnd",d),a}),d.prototype.getName=function(){return"WrappedRange"},a.WrappedRange=d,a.createRange=function(b){return b=b||document,new d(a.createNativeRange(b))},a.createRangyRange=function(a){return a=a||document,new g(a)},a.createIframeRange=function(b){return a.createRange(e.getIframeDocument(b))},a.createIframeRangyRange=function(b){return a.createRangyRange(e.getIframeDocument(b))},a.addCreateMissingNativeApiListener(function(b){b=b.document,"undefined"==typeof b.createRange&&(b.createRange=function(){return a.createRange(this)}),b=b=null})}),rangy.createModule("WrappedSelection",function(a,b){function c(a){return(a||window).getSelection()}function d(a){return(a||window).document.selection}function e(a,b,c){var d=c?"end":"start";c=c?"start":"end",a.anchorNode=b[d+"Container"],a.anchorOffset=b[d+"Offset"],a.focusNode=b[c+"Container"],a.focusOffset=b[c+"Offset"]}function f(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0,a._ranges.length=0}function g(b){var c;return b instanceof t?(c=b._selectionNativeRange,c||(c=a.createNativeRange(r.getDocument(b.startContainer)),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset),b._selectionNativeRange=c,b.attachListener("detach",function(){this._selectionNativeRange=null}))):b instanceof u?c=b.nativeRange:a.features.implementsDomRange&&b instanceof r.getWindow(b.startContainer).Range&&(c=b),c}function h(a){var b,c=a.getNodes();a:if(c.length&&1==c[0].nodeType){b=1;for(var d=c.length;d>b;++b)if(!r.isAncestorOf(c[0],c[b])){b=!1;break a}b=!0}else b=!1;if(!b)throw Error("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return c[0]}function i(a,b){var c=new u(b);a._ranges=[c],e(a,c,!1),a.rangeCount=1,a.isCollapsed=c.collapsed}function j(b){if(b._ranges.length=0,"None"==b.docSelection.type)f(b);else{var c=b.docSelection.createRange();if(c&&"undefined"!=typeof c.text)i(b,c);else{b.rangeCount=c.length;for(var d,g=r.getDocument(c.item(0)),h=0;h<b.rangeCount;++h)d=a.createRange(g),d.selectNode(c.item(h)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed,e(b,b._ranges[b.rangeCount-1],!1)}}}function k(a,b){var c=a.docSelection.createRange(),d=h(b),e=r.getDocument(c.item(0));e=r.getBody(e).createControlRange();for(var f=0,g=c.length;g>f;++f)e.add(c.item(f));try{e.add(d)}catch(i){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}e.select(),j(a)}function l(a,b,c){this.nativeSelection=a,this.docSelection=b,this._ranges=[],this.win=c,this.refresh()}function m(a,b){var c=r.getDocument(b[0].startContainer);c=r.getBody(c).createControlRange();for(var d,e=0;e<rangeCount;++e){d=h(b[e]);try{c.add(d)}catch(f){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}c.select(),j(a)}function n(a,b){if(a.anchorNode&&r.getDocument(a.anchorNode)!==r.getDocument(b))throw new v("WRONG_DOCUMENT_ERR")}function o(a){var b=[],c=new w(a.anchorNode,a.anchorOffset),d=new w(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var f=0,g=a.rangeCount;g>f;++f)b[f]=t.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.requireModules(["DomUtil","DomRange","WrappedRange"]),a.config.checkSelectionRanges=!0;var p,q,r=a.dom,s=a.util,t=a.DomRange,u=a.WrappedRange,v=a.DOMException,w=r.DomPosition,x=a.util.isHostMethod(window,"getSelection"),y=a.util.isHostObject(document,"selection"),z=y&&(!x||a.config.preferTextRange);z?(p=d,a.isSelectionValid=function(a){a=(a||window).document;var b=a.selection;return"None"!=b.type||r.getDocument(b.createRange().parentElement())==a}):x?(p=c,a.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected."),a.getNativeSelection=p,x=p();var A=a.createNativeRange(document),B=r.getBody(document),C=s.areHostObjects(x,s.areHostProperties(x,["anchorOffset","focusOffset"]));a.features.selectionHasAnchorAndFocus=C;var D=s.isHostMethod(x,"extend");a.features.selectionHasExtend=D;var E="number"==typeof x.rangeCount;a.features.selectionHasRangeCount=E;var F=!1,G=!0;s.areHostMethods(x,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof x.rangeCount&&a.features.implementsDomRange&&function(){var a=document.createElement("iframe");a.frameBorder=0,a.style.position="absolute",a.style.left="-10000px",B.appendChild(a);var b=r.getIframeDocument(a);b.open(),b.write("<html><head></head><body>12</body></html>"),b.close();var c=r.getIframeWindow(a).getSelection(),d=b.documentElement.lastChild.firstChild;b=b.createRange(),b.setStart(d,1),b.collapse(!0),c.addRange(b),G=1==c.rangeCount,c.removeAllRanges();var e=b.cloneRange();b.setStart(d,0),e.setEnd(d,2),c.addRange(b),c.addRange(e),F=2==c.rangeCount,b.detach(),e.detach(),B.removeChild(a)}(),a.features.selectionSupportsMultipleRanges=F,a.features.collapsedNonEditableSelectionsSupported=G;var H,I=!1;B&&s.isHostMethod(B,"createControlRange")&&(H=B.createControlRange(),s.areHostProperties(H,["item","add"])&&(I=!0)),a.features.implementsControlRange=I,q=C?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var J;if(s.isHostMethod(x,"getRangeAt")?J=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:C&&(J=function(b){var c=r.getDocument(b.anchorNode);return c=a.createRange(c),c.setStart(b.anchorNode,b.anchorOffset),c.setEnd(b.focusNode,b.focusOffset),c.collapsed!==this.isCollapsed&&(c.setStart(b.focusNode,b.focusOffset),c.setEnd(b.anchorNode,b.anchorOffset)),c}),a.getSelection=function(a){a=a||window;var b=a._rangySelection,c=p(a),e=y?d(a):null;return b?(b.nativeSelection=c,b.docSelection=e,b.refresh(a)):(b=new l(c,e,a),a._rangySelection=b),b},a.getIframeSelection=function(b){return a.getSelection(r.getIframeWindow(b))},H=l.prototype,!z&&C&&s.areHostMethods(x,["removeAllRanges","addRange"])){H.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),f(this)};var K=function(b,c){var d=t.getRangeDocument(c);d=a.createRange(d),d.collapseToPoint(c.endContainer,c.endOffset),b.nativeSelection.addRange(g(d)),b.nativeSelection.extend(c.startContainer,c.startOffset),b.refresh()};H.addRange=E?function(b,c){if(I&&y&&"Control"==this.docSelection.type)k(this,b);else if(c&&D)K(this,b);else{var d;F?d=this.rangeCount:(this.removeAllRanges(),d=0),this.nativeSelection.addRange(g(b)),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==d+1?(a.config.checkSelectionRanges&&(d=J(this.nativeSelection,this.rangeCount-1))&&!t.rangesEqual(d,b)&&(b=new u(d)),this._ranges[this.rangeCount-1]=b,e(this,b,N(this.nativeSelection)),this.isCollapsed=q(this)):this.refresh()}}:function(a,b){b&&D?K(this,a):(this.nativeSelection.addRange(g(a)),this.refresh())},H.setRanges=function(a){if(I&&a.length>1)m(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;c>b;++b)this.addRange(a[b])}}}else{if(!(s.isHostMethod(x,"empty")&&s.isHostMethod(A,"select")&&I&&z))return b.fail("No means of selecting a Range or TextRange was found"),!1;H.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=r.getDocument(this.anchorNode);else if("Control"==this.docSelection.type){var b=this.docSelection.createRange();b.length&&(a=r.getDocument(b.item(0)).body.createTextRange())}a&&(a.body.createTextRange().select(),this.docSelection.empty())}}catch(c){}f(this)},H.addRange=function(a){"Control"==this.docSelection.type?k(this,a):(u.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,e(this,a,!1))},H.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?m(this,a):b&&this.addRange(a[0])}}H.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new v("INDEX_SIZE_ERR");return this._ranges[a]};var L;if(z)L=function(b){var c;a.isSelectionValid(b.win)?c=b.docSelection.createRange():(c=r.getBody(b.win.document).createTextRange(),c.collapse(!0)),"Control"==b.docSelection.type?j(b):c&&"undefined"!=typeof c.text?i(b,c):f(b)};else if(s.isHostMethod(x,"getRangeAt")&&"number"==typeof x.rangeCount)L=function(b){if(I&&y&&"Control"==b.docSelection.type)j(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;d>c;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));e(b,b._ranges[b.rangeCount-1],N(b.nativeSelection)),b.isCollapsed=q(b)}else f(b)};else{if(!C||"boolean"!=typeof x.isCollapsed||"boolean"!=typeof A.collapsed||!a.features.implementsDomRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;L=function(a){var b;b=a.nativeSelection,b.anchorNode?(b=J(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,a.isCollapsed=q(a)):f(a)}}H.refresh=function(a){var b=a?this._ranges.slice(0):null;if(L(this),a){if(a=b.length,a!=this._ranges.length)return!1;for(;a--;)if(!t.rangesEqual(b[a],this._ranges[a]))return!1;return!0}};var M=function(a,b){var c=a.getAllRanges(),d=!1;a.removeAllRanges();for(var e=0,g=c.length;g>e;++e)d||b!==c[e]?a.addRange(c[e]):d=!0;a.rangeCount||f(a)};H.removeRange=I?function(a){if("Control"==this.docSelection.type){var b=this.docSelection.createRange();a=h(a);var c=r.getDocument(b.item(0));c=r.getBody(c).createControlRange();for(var d,e=!1,f=0,g=b.length;g>f;++f)d=b.item(f),d!==a||e?c.add(b.item(f)):e=!0;c.select(),j(this)}else M(this,a)}:function(a){M(this,a)};var N;!z&&C&&a.features.implementsDomRange?(N=function(a){var b=!1;return a.anchorNode&&(b=1==r.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)),b},H.isBackwards=function(){return N(this)
}):N=H.isBackwards=function(){return!1},H.toString=function(){for(var a=[],b=0,c=this.rangeCount;c>b;++b)a[b]=""+this._ranges[b];return a.join("")},H.collapse=function(b,c){n(this,b);var d=a.createRange(r.getDocument(b));d.collapseToPoint(b,c),this.removeAllRanges(),this.addRange(d),this.isCollapsed=!0},H.collapseToStart=function(){if(!this.rangeCount)throw new v("INVALID_STATE_ERR");var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)},H.collapseToEnd=function(){if(!this.rangeCount)throw new v("INVALID_STATE_ERR");var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)},H.selectAllChildren=function(b){n(this,b);var c=a.createRange(r.getDocument(b));c.selectNodeContents(b),this.removeAllRanges(),this.addRange(c)},H.deleteFromDocument=function(){if(I&&y&&"Control"==this.docSelection.type){for(var a,b=this.docSelection.createRange();b.length;)a=b.item(0),b.remove(a),a.parentNode.removeChild(a);this.refresh()}else if(this.rangeCount){b=this.getAllRanges(),this.removeAllRanges(),a=0;for(var c=b.length;c>a;++a)b[a].deleteContents();this.addRange(b[c-1])}},H.getAllRanges=function(){return this._ranges.slice(0)},H.setSingleRange=function(a){this.setRanges([a])},H.containsNode=function(a,b){for(var c=0,d=this._ranges.length;d>c;++c)if(this._ranges[c].containsNode(a,b))return!0;return!1},H.toHtml=function(){var a="";if(this.rangeCount){a=t.getRangeDocument(this._ranges[0]).createElement("div");for(var b=0,c=this._ranges.length;c>b;++b)a.appendChild(this._ranges[b].cloneContents());a=a.innerHTML}return a},H.getName=function(){return"WrappedSelection"},H.inspect=function(){return o(this)},H.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null},l.inspect=o,a.Selection=l,a.selectionPrototype=H,a.addCreateMissingNativeApiListener(function(b){"undefined"==typeof b.getSelection&&(b.getSelection=function(){return a.getSelection(this)}),b=null})}),rangy.createModule("SaveRestore",function(a,b){function c(a,b){var c,d="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),e=g.getDocument(a.startContainer),f=a.cloneRange();return f.collapse(b),c=e.createElement("span"),c.id=d,c.style.lineHeight="0",c.style.display="none",c.className="rangySelectionBoundary",c.appendChild(e.createTextNode(h)),f.insertNode(c),f.detach(),c}function d(a,c,d,e){(a=(a||document).getElementById(d))?(c[e?"setStartBefore":"setEndBefore"](a),a.parentNode.removeChild(a)):b.warn("Marker element has been removed. Cannot restore selection.")}function e(a,b){return b.compareBoundaryPoints(a.START_TO_START,a)}function f(a,b){var c=(a||document).getElementById(b);c&&c.parentNode.removeChild(c)}a.requireModules(["DomUtil","DomRange","WrappedRange"]);var g=a.dom,h="Ôªø";a.saveSelection=function(d){d=d||window;var f=d.document;if(a.isSelectionValid(d)){var g,h,i=a.getSelection(d),j=i.getAllRanges(),k=[];j.sort(e);for(var l=0,m=j.length;m>l;++l)g=j[l],g.collapsed?(h=c(g,!1),k.push({markerId:h.id,collapsed:!0})):(h=c(g,!1),g=c(g,!0),k[l]={startMarkerId:g.id,endMarkerId:h.id,collapsed:!1,backwards:1==j.length&&i.isBackwards()});for(l=m-1;l>=0;--l)g=j[l],g.collapsed?g.collapseBefore((f||document).getElementById(k[l].markerId)):(g.setEndBefore((f||document).getElementById(k[l].endMarkerId)),g.setStartAfter((f||document).getElementById(k[l].startMarkerId)));return i.setRanges(j),{win:d,doc:f,rangeInfos:k,restored:!1}}b.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus.")},a.restoreSelection=function(c,e){if(!c.restored){for(var f,g,h=c.rangeInfos,i=a.getSelection(c.win),j=[],k=h.length,l=k-1;l>=0;--l){if(f=h[l],g=a.createRange(c.doc),f.collapsed)if(f=(c.doc||document).getElementById(f.markerId)){f.style.display="inline";var m=f.previousSibling;m&&3==m.nodeType?(f.parentNode.removeChild(f),g.collapseToPoint(m,m.length)):(g.collapseBefore(f),f.parentNode.removeChild(f))}else b.warn("Marker element has been removed. Cannot restore selection.");else d(c.doc,g,f.startMarkerId,!0),d(c.doc,g,f.endMarkerId,!1);1==k&&g.normalizeBoundaries(),j[l]=g}1==k&&e&&a.features.selectionHasExtend&&h[0].backwards?(i.removeAllRanges(),i.addRange(j[0],!0)):i.setRanges(j),c.restored=!0}},a.removeMarkerElement=f,a.removeMarkers=function(a){for(var b,c=a.rangeInfos,d=0,e=c.length;e>d;++d)b=c[d],b.collapsed?f(a.doc,b.markerId):(f(a.doc,b.startMarkerId),f(a.doc,b.endMarkerId))}}),rangy.createModule("CssClassApplier",function(a,b){function c(a,b){return a.className&&RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function d(a,b){a.className?c(a,b)||(a.className+=" "+b):a.className=b}function e(a){return a.split(/\s+/).sort().join(" ")}function f(a,b){return e(a.className)==e(b.className)}function g(a){for(var b=a.parentNode;a.hasChildNodes();)b.insertBefore(a.firstChild,a);b.removeChild(a)}function h(a,b){var c=a.cloneRange();c.selectNodeContents(b);var d=c.intersection(a);return d=d?d.toString():"",c.detach(),""!=d}function i(a){return a.getNodes([3],function(b){return h(a,b)})}function j(a,b){if(a.attributes.length!=b.attributes.length)return!1;for(var c,d,e=0,f=a.attributes.length;f>e;++e)if(c=a.attributes[e],d=c.name,"class"!=d){if(d=b.attributes.getNamedItem(d),c.specified!=d.specified)return!1;if(c.specified&&c.nodeValue!==d.nodeValue)return!1}return!0}function k(a,b){for(var c,d=0,e=a.attributes.length;e>d;++d)if(c=a.attributes[d].name,(!b||!u.arrayContains(b,c))&&a.attributes[d].specified&&"class"!=c)return!0;return!1}function l(a){var b;return a&&1==a.nodeType&&((b=a.parentNode)&&9==b.nodeType&&"on"==b.designMode||w(a)&&!w(a.parentNode))}function m(a){return(w(a)||1!=a.nodeType&&w(a.parentNode))&&!l(a)}function n(a){return a&&1==a.nodeType&&!x.test(t(a,"display"))}function o(a){if(0==a.data.length)return!0;if(y.test(a.data))return!1;switch(t(a.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(a.data))return!1}return n(a.previousSibling)||n(a.nextSibling)}function p(a,c,d,e){var f,g=0==d;if(u.isAncestorOf(c,a))return a;if(u.isCharacterDataNode(c))if(0==d)d=u.getNodeIndex(c),c=c.parentNode;else{if(d!=c.length)throw b.createError("splitNodeAt should not be called with offset in the middle of a data node ("+d+" in "+c.data);d=u.getNodeIndex(c)+1,c=c.parentNode}var h;h=c;var i=d;if(h=u.isCharacterDataNode(h)?0==i?!!h.previousSibling:i==h.length?!!h.nextSibling:!0:i>0&&i<h.childNodes.length){if(!f){for(f=c.cloneNode(!1),f.id&&f.removeAttribute("id");g=c.childNodes[d];)f.appendChild(g);u.insertAfter(f,c)}return c==a?f:p(a,f.parentNode,u.getNodeIndex(f),e)}return a!=c?(f=c.parentNode,c=u.getNodeIndex(c),g||c++,p(a,f,c,e)):a}function q(a){var b=a?"nextSibling":"previousSibling";return function(c,d){var e=c.parentNode,g=c[b];if(g){if(g&&3==g.nodeType)return g}else if(d&&(g=e[b])&&1==g.nodeType&&e.tagName==g.tagName&&f(e,g)&&j(e,g))return g[a?"firstChild":"lastChild"];return null}}function r(a){this.firstTextNode=(this.isElementMerge=1==a.nodeType)?a.lastChild:a,this.textNodes=[this.firstTextNode]}function s(a,b,c){this.cssClass=a;var d,f,g=null;if("object"==typeof b&&null!==b){for(c=b.tagNames,g=b.elementProperties,d=0;f=B[d++];)b.hasOwnProperty(f)&&(this[f]=b[f]);d=b.normalize}else d=b;this.normalize="undefined"==typeof d?!0:d,this.attrExceptions=[],d=document.createElement(this.elementTagName),this.elementProperties={};for(var h in g)g.hasOwnProperty(h)&&(C.hasOwnProperty(h)&&(h=C[h]),d[h]=g[h],this.elementProperties[h]=d[h],this.attrExceptions.push(h));if(this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?e(this.elementProperties.className+" "+a):a,this.applyToAnyTagName=!1,a=typeof c,"string"==a)"*"==c?this.applyToAnyTagName=!0:this.tagNames=c.toLowerCase().replace(/^\s\s*/,"").replace(/\s\s*$/,"").split(/\s*,\s*/);else if("object"==a&&"number"==typeof c.length)for(this.tagNames=[],d=0,a=c.length;a>d;++d)"*"==c[d]?this.applyToAnyTagName=!0:this.tagNames.push(c[d].toLowerCase());else this.tagNames=[this.elementTagName]}a.requireModules(["WrappedSelection","WrappedRange"]);var t,u=a.dom,v=function(){function a(a,b,c){return b&&c?" ":""}return function(b,c){b.className&&(b.className=b.className.replace(RegExp("(?:^|\\s)"+c+"(?:\\s|$)"),a))}}();"undefined"!=typeof window.getComputedStyle?t=function(a,b){return u.getWindow(a).getComputedStyle(a,null)[b]}:"undefined"!=typeof document.documentElement.currentStyle?t=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found");var w;!function(){w="boolean"==typeof document.createElement("div").isContentEditable?function(a){return a&&1==a.nodeType&&a.isContentEditable}:function(a){return a&&1==a.nodeType&&"false"!=a.contentEditable?"true"==a.contentEditable||w(a.parentNode):!1}}();var x=/^inline(-block|-table)?$/i,y=/[^\r\n\t\f \u200B]/,z=q(!1),A=q(!0);r.prototype={doMerge:function(){for(var a,b,c=[],d=0,e=this.textNodes.length;e>d;++d)a=this.textNodes[d],b=a.parentNode,c[d]=a.data,d&&(b.removeChild(a),b.hasChildNodes()||b.parentNode.removeChild(b));return this.firstTextNode.data=c=c.join("")},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,c=this.textNodes.length;c>b;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var B=["elementTagName","ignoreWhiteSpace","applyToEditableOnly"],C={"class":"className"};s.prototype={elementTagName:"span",elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,hasClass:function(a){return 1==a.nodeType&&u.arrayContains(this.tagNames,a.tagName.toLowerCase())&&c(a,this.cssClass)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a,this.cssClass))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||m(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&3==a.nodeType&&o(a)},postApply:function(a,b,c){for(var d,e,f,g=a[0],h=a[a.length-1],i=[],j=g,k=h,l=0,m=h.length,n=0,o=a.length;o>n;++n)e=a[n],(f=z(e,!c))?(d||(d=new r(f),i.push(d)),d.textNodes.push(e),e===g&&(j=d.firstTextNode,l=j.length),e===h&&(k=d.firstTextNode,m=d.getLength())):d=null;if((a=A(h,!c))&&(d||(d=new r(h),i.push(d)),d.textNodes.push(a)),i.length){for(n=0,o=i.length;o>n;++n)i[n].doMerge();b.setStart(j,l),b.setEnd(k,m)}},createContainer:function(b){return b=b.createElement(this.elementTagName),a.util.extend(b,this.elementProperties),d(b,this.cssClass),b},applyToTextNode:function(a){var b=a.parentNode;1==b.childNodes.length&&u.arrayContains(this.tagNames,b.tagName.toLowerCase())?d(b,this.cssClass):(b=this.createContainer(u.getDocument(a)),a.parentNode.insertBefore(b,a),b.appendChild(a))},isRemovable:function(a){var b;if(b=a.tagName.toLowerCase()==this.elementTagName){if(b=e(a.className)==this.elementSortedClassName){var c;a:{b=this.elementProperties;for(c in b)if(b.hasOwnProperty(c)&&a[c]!==b[c]){c=!1;break a}c=!0}b=c&&!k(a,this.attrExceptions)&&this.isModifiable(a)}b=b}return b},undoToTextNode:function(a,b,c){b.containsNode(c)||(a=b.cloneRange(),a.selectNode(c),a.isPointInRange(b.endContainer,b.endOffset)&&(p(c,b.endContainer,b.endOffset,[b]),b.setEndAfter(c)),a.isPointInRange(b.startContainer,b.startOffset)&&(c=p(c,b.startContainer,b.startOffset,[b]))),this.isRemovable(c)?g(c):v(c,this.cssClass)},applyToRange:function(a){a.splitBoundaries();var b=i(a);if(b.length){for(var c,d=0,e=b.length;e>d;++d)c=b[d],!this.isIgnorableWhiteSpaceNode(c)&&!this.getSelfOrAncestorWithClass(c)&&this.isModifiable(c)&&this.applyToTextNode(c);a.setStart(b[0],0),c=b[b.length-1],a.setEnd(c,c.length),this.normalize&&this.postApply(b,a,!1)}},applyToSelection:function(b){b=b||window,b=a.getSelection(b);var c,d=b.getAllRanges();b.removeAllRanges();for(var e=d.length;e--;)c=d[e],this.applyToRange(c),b.addRange(c)},undoToRange:function(a){a.splitBoundaries();var b,c,d=i(a),e=d[d.length-1];if(d.length){for(var f=0,g=d.length;g>f;++f)b=d[f],(c=this.getSelfOrAncestorWithClass(b))&&this.isModifiable(b)&&this.undoToTextNode(b,a,c),a.setStart(d[0],0),a.setEnd(e,e.length);this.normalize&&this.postApply(d,a,!0)}},undoToSelection:function(b){b=b||window,b=a.getSelection(b);var c,d=b.getAllRanges();b.removeAllRanges();for(var e=0,f=d.length;f>e;++e)c=d[e],this.undoToRange(c),b.addRange(c)},getTextSelectedByRange:function(a,b){var c=b.cloneRange();c.selectNodeContents(a);var d=c.intersection(b);return d=d?d.toString():"",c.detach(),d},isAppliedToRange:function(a){if(a.collapsed)return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);for(var b,c=a.getNodes([3]),d=0;b=c[d++];)if(!this.isIgnorableWhiteSpaceNode(b)&&h(a,b)&&this.isModifiable(b)&&!this.getSelfOrAncestorWithClass(b))return!1;return!0},isAppliedToSelection:function(b){b=b||window,b=a.getSelection(b).getAllRanges();for(var c=b.length;c--;)if(!this.isAppliedToRange(b[c]))return!1;return!0},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},detach:function(){}},s.util={hasClass:c,addClass:d,removeClass:v,hasSameClasses:f,replaceWithOwnChildren:g,elementsHaveSameNonClassAttributes:j,elementHasNonClassAttributes:k,splitNodeAt:p,isEditableElement:w,isEditingHost:l,isEditable:m},a.CssClassApplier=s,a.createCssClassApplier=function(a,b,c){return new s(a,b,c)}}),rangy.createModule("Coordinates",function(a){function b(a,b){var c={top:Math.min(a.top,b.top),bottom:Math.max(a.bottom,b.bottom),left:Math.min(a.left,b.left),right:Math.max(a.right,b.right)};return c.width=c.right-c.left,c.height=c.bottom-c.top,c}a.requireModules(["WrappedSelection","WrappedRange"]);var c=a.WrappedRange,d=function(){var d=a.createNativeRange(),e=!1,f=!1;if(a.features.implementsTextRange)return function(b){var d=a.util.isTextRange(b.nativeRange)?b.nativeRange:c.rangeToTextRange(b),e=d.boundingLeft,f=d.boundingTop,g=d.boundingWidth,h=d.boundingHeight;return{top:f,bottom:f+h,left:e,right:e+g,width:g,height:h}};if(a.features.implementsDomRange){e=a.util.isHostMethod(d,"getBoundingClientRect"),a.features.rangeSupportsGetBoundingClientRect=e;var g=function(a){return a instanceof c?a:new c(a)};if(e)return function(a){return g(a).nativeRange.getBoundingClientRect()};var h=document.createElement("span");f=a.util.isHostMethod(h,"getBoundingClientRect");var i=f?function(a){return a.getBoundingClientRect()}:function(a){for(var b=0,c=0,d=a,e=a.offsetWidth,f=a.offsetHeight;d;)b+=d.offsetLeft,c+=d.offsetTop,d=d.offsetParent;return{top:c,bottom:c+f,left:b,right:b+e,width:e,height:f}},j=function(a){a.splitBoundaries();var c=document.createElement("span"),d=a.cloneRange();d.collapse(!0),d.insertNode(c);var e=i(c);c.parentNode.removeChild(c),d.collapseToPoint(a.endContainer,a.endOffset),d.insertNode(c);var f=i(c);return c.parentNode.removeChild(c),a.normalizeBoundaries(),b(e,f)};return function(a){return j(g(a))}}}();a.getRangeBoundingClientRect=d,a.rangePrototype.getBoundingClientRect=function(){return d(this)},function(){function b(a){return function(){var b=this.cloneRange();b.collapse(a);var c=d(this);return{left:c.left,top:c.top}}}a.rangePrototype.getStartClientPos=b(!0),a.rangePrototype.getEndClientPos=b(!1)}(),a.selectionPrototype.getBoundingClientRect=function(){for(var a,c=0,e=null;c<this.rangeCount;++c)a=d(this.getRangeAt(c)),e=e?b(e,a):a;return e}});